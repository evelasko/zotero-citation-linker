# Project Workflow & Organization

## Project Structure Overview

### **Current Project State**
```
ZoteroCitationLinker/
â”œâ”€â”€ .taskmaster/              # âœ… Task management system
â”‚   â”œâ”€â”€ tasks/
â”‚   â”‚   â””â”€â”€ tasks.json       # âœ… 10 main tasks, 47 subtasks
â”‚   â”œâ”€â”€ config.json          # âœ… AI model configuration
â”‚   â””â”€â”€ docs/               # âœ… Research documentation
â”œâ”€â”€ .cursor/                # âœ… Development rules (this system)
â”‚   â””â”€â”€ rules/              # âœ… Comprehensive development guidelines
â”œâ”€â”€ zotero-source/          # âœ… Complete Zotero codebase reference
â”œâ”€â”€ zotero-make-it-red-main/     # âœ… Simple plugin example
â”œâ”€â”€ zotero-date-from-last-modified-master/ # âœ… Advanced plugin example
â”œâ”€â”€ prd.txt                 # âœ… Original project requirements
â””â”€â”€ [Plugin implementation] # ğŸš§ To be created following tasks
```

### **Target Plugin Structure**
```
src/                        # âœ… TypeScript source files
â”œâ”€â”€ manifest.json          # âœ… Plugin metadata
â”œâ”€â”€ bootstrap.ts           # âœ… Plugin lifecycle management
â”œâ”€â”€ lib.ts                 # âœ… Main plugin implementation
â”œâ”€â”€ citation-service.ts    # âœ… Citation generation logic
â”œâ”€â”€ server-service.ts      # âœ… HTTP server implementation
â”œâ”€â”€ context-menu.ts        # âœ… Context menu integration
â”œâ”€â”€ preferences.xhtml      # âœ… Settings UI
â””â”€â”€ types.ts              # âœ… TypeScript type definitions

locale/                    # âœ… Internationalization
â””â”€â”€ en-US/
    â””â”€â”€ citation-linker.ftl

client/                    # âœ… Build output (gitignored)
```

## Development Workflow

### **Task-Driven Development Process**
```bash
# âœ… PHASE 1: Start Development Session
task-master next                    # Check next available task
task-master show <task-id>         # Read task context and requirements
task-master set-status --id=<id> --status=in-progress

# âœ… PHASE 2: Research & Plan
# For complex tasks, research first
task-master research "Zotero plugin context menu patterns" --save-to <id> --tree --files=zotero-source/chrome/content/zotero/

# Document your implementation plan
task-master update-subtask --id=<id> --prompt="
IMPLEMENTATION PLAN: [Brief description]

Approach:
- [Step 1]
- [Step 2] 
- [Step 3]

Files to create/modify:
- [List files]

Zotero APIs to use:
- [List APIs]

Dependencies:
- [Task dependencies]
"

# âœ… PHASE 3: Implement
# Write code following the established patterns
# Test incrementally

# âœ… PHASE 4: Document & Complete
task-master update-subtask --id=<id> --prompt="
IMPLEMENTATION COMPLETE: [Brief description]

What was implemented:
- [Specific changes]

Key discoveries:
- [Important findings]
- [API patterns used]
- [Issues encountered and solutions]

Testing results:
- [What was tested]
- [Results]

Files modified:
- [List with brief description]
"

task-master set-status --id=<id> --status=done

# âœ… PHASE 5: Commit Changes
git add .
git commit -m "feat: implement [feature] (task <id>)

[Detailed description]

Refs: task-master task <id>"
```

### **Git Workflow Standards**

#### **Commit Message Format**
```bash
# âœ… DO: Use conventional commit format with task references
feat: implement context menu integration (task 2.1)

- Add context menu item "Copy Markdown Citation"
- Integrate with existing Zotero item context menu
- Handle single and multiple item selection
- Add proper keyboard shortcut support

Refs: task-master task 2.1

# âœ… DO: Use these prefixes
feat:     # New features
fix:      # Bug fixes  
refactor: # Code refactoring
docs:     # Documentation changes
test:     # Adding tests
build:    # Build system changes
style:    # Code style changes
```

#### **Branch Strategy**
```bash
# âœ… DO: Work on main branch for this project (solo development)
# âœ… DO: Create feature branches for major task groups if needed

git checkout -b task-group-1-setup     # Tasks 1-3: Project setup
git checkout -b task-group-2-ui        # Tasks 2,3: UI components  
git checkout -b task-group-3-server    # Tasks 5-7: Server features

# âœ… DO: Merge back to main when task group is complete
git checkout main
git merge task-group-1-setup
git branch -d task-group-1-setup
```

#### **Git Ignore Configuration**
```gitignore
# Node.js
node_modules/
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# Build outputs
client/
dist/
*.xpi
*.zip

# Development
.eslintcache/
.tsbuildinfo
*.tsbuildinfo

# IDEs
.vscode/
.idea/
*.swp
*.swo

# OS
.DS_Store
Thumbs.db

# Logs
*.log

# TypeScript
*.tsbuildinfo

# Runtime
.env.local
.env.development.local
.env.test.local
.env.production.local
```

## Quality Assurance Standards

### **Before Each Commit**
```bash
# âœ… DO: Run these checks before committing
npm run lint              # Check code style
npm run type-check        # Verify TypeScript
npm run build            # Ensure build works
# Manual testing in Zotero for functionality
```

### **Testing Checklist**
```typescript
// âœ… DO: Test these scenarios for each feature

// Context Menu Testing
- [ ] Menu item appears for regular items
- [ ] Menu item hidden for attachments/notes  
- [ ] Works with single item selection
- [ ] Works with multiple item selection
- [ ] Keyboard shortcut works
- [ ] Menu item disabled when appropriate

// Citation Generation Testing
- [ ] Works with different item types (book, article, webpage)
- [ ] Respects user's current citation style
- [ ] Handles missing fields gracefully
- [ ] API links are correctly formatted
- [ ] Clipboard operations work

// Server Testing  
- [ ] Server starts on correct port
- [ ] Endpoints respond correctly
- [ ] Error handling works
- [ ] Input validation prevents crashes
- [ ] JSON responses are properly formatted
```

### **Code Review Standards**
```typescript
// âœ… DO: Follow these patterns in code

// Proper error handling
try {
  const result = await someZoteroAPI();
  return this.formatResponse(result);
} catch (error) {
  this.log(`Operation failed: ${error.message}`, 'error');
  throw error;
}

// Consistent logging
this.log(`Starting ${operation}`, 'debug');
this.log(`${operation} completed successfully`, 'debug');

// Input validation
if (!url || typeof url !== 'string') {
  throw new Error('Invalid URL provided');
}

// Proper type annotations
async function generateCitation(item: ZoteroItem): Promise<string> {
  // Implementation
}
```

## Reference Management

### **Using Provided Resources**
```bash
# âœ… DO: Leverage the reference materials effectively

# When implementing context menus:
grep -r "buildItemContextMenu" zotero-source/chrome/content/zotero/
# Look at: zotero-source/chrome/content/zotero/zoteroPane.js:3577

# When implementing citation generation:
grep -r "QuickCopy" zotero-source/chrome/content/zotero/
# Look at: zotero-source/chrome/content/zotero/xpcom/quickCopy.js

# When implementing server features:
find zotero-source -name "*server*" -type f
# Look at: zotero-source/chrome/content/zotero/xpcom/server/

# Study the advanced example plugin:
ls -la zotero-date-from-last-modified-master/
# Focus on: package.json, tsconfig.json, esbuild.js, bootstrap.ts, lib.ts
```

### **Documentation Strategy**
```markdown
# âœ… DO: Document key decisions and patterns

## Context Menu Integration
Based on zotero-source/chrome/content/zotero/zoteroPane.js:3577
- Use createXULElement for menu items
- Insert after existing separators  
- Register in addToWindow/removeFromWindow pattern
- Handle cleanup properly

## Citation Generation
Based on zotero-source/chrome/content/zotero/xpcom/quickCopy.js
- Use Zotero.QuickCopy.getContentFromItems()
- Respects user's citation style preference
- Handle both single citations and bibliography format

## Server Implementation  
Based on zotero-source/chrome/content/zotero/xpcom/server/
- Use Zotero.Server.Endpoints pattern
- Implement proper request validation
- Return structured JSON responses
```

## Performance & Optimization

### **Development Performance**
```bash
# âœ… DO: Optimize development workflow

# Use watch mode for rapid iteration
npm run watch

# Use incremental building
npm run build

# Test individual components
# Load plugin in Zotero development mode
# Use Zotero's error console for debugging
```

### **Runtime Performance**
```typescript
// âœ… DO: Optimize for Zotero's performance expectations

// Lazy load heavy operations
private async ensureTranslationReady() {
  if (!this._translationService) {
    this._translationService = new Zotero.Translate.Web();
  }
}

// Cache expensive computations
private _citationCache = new Map<string, string>();

generateCitation(item: ZoteroItem): string {
  const cacheKey = item.key;
  if (this._citationCache.has(cacheKey)) {
    return this._citationCache.get(cacheKey)!;
  }
  
  const citation = this._generateCitationInternal(item);
  this._citationCache.set(cacheKey, citation);
  return citation;
}

// Use async operations properly
async processItems(items: ZoteroItem[]): Promise<void> {
  // Process in batches to avoid blocking UI
  const batchSize = 10;
  for (let i = 0; i < items.length; i += batchSize) {
    const batch = items.slice(i, i + batchSize);
    await Promise.all(batch.map(item => this.processItem(item)));
    
    // Yield control to UI
    await new Promise(resolve => setTimeout(resolve, 0));
  }
}
```

## Integration Guidelines

### **Obsidian Plugin Preparation**
```typescript
// âœ… DO: Design API for future Obsidian integration

interface CitationLinkerAPI {
  // Simple URL-to-citation endpoint
  addFromURL(url: string): Promise<{
    status: 'success' | 'error';
    citation?: string;
    zoteroLink?: string;
    itemKey?: string;
    message?: string;
  }>;
  
  // Health check endpoint  
  ping(): Promise<{ status: 'ok'; version: string }>;
}

// âœ… DO: Document API for future use
/*
Obsidian Plugin Integration Notes:

The Zotero Citation Linker exposes HTTP endpoints for external integration:

POST http://localhost:23119/citation-linker/add-from-url
Body: { "url": "https://example.com/paper" }
Response: {
  "status": "success",
  "citation": "(Author, 2023)",
  "zoteroLink": "https://api.zotero.org/users/123/items/ABC123", 
  "itemKey": "ABC123"
}

The Obsidian plugin can use this to:
1. Send URLs from selected text or clipboard
2. Insert formatted citations
3. Store Zotero links for reference
4. Enable click-to-open-in-Zotero functionality
*/
```

## Troubleshooting Guide

### **Common Development Issues**
```bash
# âŒ Issue: Plugin not loading in Zotero
# âœ… Solutions:
- Check manifest.json syntax (use JSON validator)
- Verify bootstrap.ts exports startup/shutdown functions
- Check Zotero error console for specific errors
- Ensure strict_min_version matches your Zotero version

# âŒ Issue: TypeScript compilation errors
# âœ… Solutions:
- npm install zotero-types
- Check tsconfig.json target and lib settings
- Add proper declare statements for Zotero globals

# âŒ Issue: Context menu not appearing
# âœ… Solutions:
- Verify addToWindow/removeFromWindow registration
- Check menu insertion point (use proper separator)
- Ensure ZoteroPane reference is correct
- Test with different item types

# âŒ Issue: Server endpoints not responding
# âœ… Solutions:
- Check Zotero.Server.Endpoints registration
- Verify endpoint path format ("/plugin-name/endpoint")
- Test with curl or Postman
- Check server port conflicts
```

### **Debugging Workflow**
```typescript
// âœ… DO: Add debugging infrastructure

class DebugHelper {
  static enabled = Zotero.Prefs.get('extensions.citation-linker.debug', false);
  
  static log(component: string, message: string, data?: any) {
    if (!this.enabled) return;
    
    const prefix = `CitationLinker[${component}]:`;
    const fullMessage = data ? `${message} ${JSON.stringify(data)}` : message;
    Zotero.debug(`${prefix} ${fullMessage}`);
  }
  
  static error(component: string, error: Error) {
    const prefix = `CitationLinker[${component}] ERROR:`;
    Zotero.logError(`${prefix} ${error.message}`);
    if (error.stack) {
      Zotero.debug(`${prefix} Stack: ${error.stack}`);
    }
  }
}

// Usage in implementation
DebugHelper.log('ContextMenu', 'Adding menu item', { itemCount: items.length });
DebugHelper.log('Server', 'Processing request', { url: req.url });
DebugHelper.error('Citation', new Error('Invalid item type'));
```

Follow [zotero-development.mdc](mdc:.cursor/rules/zotero-development.mdc) for Zotero APIs, [typescript-build.mdc](mdc:.cursor/rules/typescript-build.mdc) for build system, and [taskmaster-integration.mdc](mdc:.cursor/rules/taskmaster-integration.mdc) for task workflow.
