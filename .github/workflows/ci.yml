name: ğŸ§ª Continuous Integration

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'

env:
  NODE_VERSION: '18'

jobs:
  # =================== CODE QUALITY ===================
  lint-and-format:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ğŸ“¦ Install dependencies
      run: npm ci
    
    - name: ğŸ” Run ESLint
      run: npm run lint
    
    - name: ğŸ“ Check TypeScript compilation
      run: npx tsc --noEmit
    
    # Optional: Add Prettier formatting check
    # - name: ğŸ¨ Check code formatting
    #   run: npx prettier --check .

  # =================== BUILD TESTING ===================
  build-test:
    name: ğŸ”¨ Build Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: ['18', '20']
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: ğŸ“¦ Install dependencies
      run: npm ci
    
    - name: ğŸ”¨ Build plugin
      run: npm run build
    
    - name: ğŸ“‚ Verify build outputs
      shell: bash
      run: |
        if [ ! -d "build" ]; then
          echo "âŒ Build directory not found!"
          exit 1
        fi
        
        if [ ! -f "build/manifest.json" ]; then
          echo "âŒ Built manifest.json not found!"
          exit 1
        fi
        
        if [ ! -f "build/bootstrap.js" ]; then
          echo "âŒ Built bootstrap.js not found!"
          exit 1
        fi
        
        if [ ! -f "build/lib.js" ]; then
          echo "âŒ Built lib.js not found!"
          exit 1
        fi
        
        # Check if XPI was created
        XPI_COUNT=$(find xpi/ -name "*.xpi" 2>/dev/null | wc -l || echo "0")
        if [ "$XPI_COUNT" -eq 0 ]; then
          echo "âŒ No XPI file found!"
          exit 1
        fi
        
        echo "âœ… All build outputs verified"

  # =================== PLUGIN VALIDATION ===================
  validate-plugin:
    name: ğŸ” Plugin Validation
    runs-on: ubuntu-latest
    needs: [lint-and-format, build-test]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ğŸ“¦ Install dependencies
      run: npm ci
    
    - name: ğŸ”¨ Build plugin
      run: npm run build
    
    - name: ğŸ” Validate manifest.json
      run: |
        # Check manifest structure
        if ! cat build/manifest.json | jq empty 2>/dev/null; then
          echo "âŒ Invalid JSON in manifest.json"
          exit 1
        fi
        
        # Check required fields
        REQUIRED_FIELDS=("manifest_version" "name" "version" "applications")
        for field in "${REQUIRED_FIELDS[@]}"; do
          if ! cat build/manifest.json | jq ".$field" | grep -v "null" > /dev/null; then
            echo "âŒ Missing required field: $field"
            exit 1
          fi
        done
        
        echo "âœ… Manifest validation passed"
    
    - name: ğŸ” Validate XPI structure
      run: |
        XPI_FILE=$(find xpi/ -name "*.xpi" | head -n 1)
        if [ -z "$XPI_FILE" ]; then
          echo "âŒ No XPI file found"
          exit 1
        fi
        
        # Check XPI contents
        unzip -l "$XPI_FILE" | grep -E "(manifest\.json|bootstrap\.js|lib\.js)" || {
          echo "âŒ XPI missing required files"
          exit 1
        }
        
        echo "âœ… XPI structure validation passed"

  # =================== SECURITY SCAN ===================
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ğŸ“¦ Install dependencies
      run: npm ci
    
    - name: ğŸ”’ Run npm audit
      run: |
        if npm audit --audit-level=moderate; then
          echo "âœ… No security vulnerabilities found"
        else
          echo "âš ï¸ Security vulnerabilities detected"
          npm audit --audit-level=moderate
          exit 1
        fi

  # =================== STATUS CHECK ===================
  ci-complete:
    name: âœ… CI Complete
    runs-on: ubuntu-latest
    needs: [lint-and-format, build-test, validate-plugin]
    if: always()
    
    steps:
    - name: ğŸ“Š Check CI status
      run: |
        if [ "${{ needs.lint-and-format.result }}" != "success" ]; then
          echo "âŒ Code quality checks failed"
          exit 1
        fi
        
        if [ "${{ needs.build-test.result }}" != "success" ]; then
          echo "âŒ Build tests failed"
          exit 1
        fi
        
        if [ "${{ needs.validate-plugin.result }}" != "success" ]; then
          echo "âŒ Plugin validation failed"
          exit 1
        fi
        
        echo "âœ… All CI checks passed successfully!" 